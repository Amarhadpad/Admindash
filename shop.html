<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shop - ArtistGrade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      padding-bottom: 50px;
    }
    .navbar-brand { font-weight: 600; font-size: 1.4rem; }
    .product-card { border: none; border-radius: 20px; overflow: hidden; background: #fff;
      transition: all 0.3s ease-in-out; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
    .product-card img { height: 200px; object-fit: cover; }
    .product-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.3rem; }
    .product-category { font-size: 0.9rem; color: #888; margin-bottom: 0.5rem; }
    .price { font-weight: 600; font-size: 1.1rem; color: #ff6f61; }
    .add-to-cart-btn { border-radius: 12px; font-size: 0.9rem; padding: 0.5rem 1rem; transition: background 0.3s ease; }
    .add-to-cart-btn:hover { background-color: #e85a50; }
    .cart-badge { background-color: #ff6f61; color: white; font-size: 12px; border-radius: 50%; padding: 3px 8px; position: relative; top: -8px; left: -5px; }
    @media (max-width: 576px) {
      .product-card img { height: 160px; }
      .product-title { font-size: 1rem; }
      .product-category { font-size: 0.8rem; }
    }
    /* NEW: Cart drawer styling */
    #cartDrawer {
      position: fixed;
      top: 0; right: -320px;
      width: 300px;
      height: 100%;
      background: #fff;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
      padding: 15px;
      transition: right 0.3s ease;
      overflow-y: auto;
      z-index: 1050;
    }
    #cartDrawer.open { right: 0; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand" href="/">ðŸŽ¨ ArtistGrade</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link fw-medium ms-3" href="/dashboard">Admin</a></li>
        <li class="nav-item">
          <a class="nav-link fw-medium position-relative" href="javascript:void(0)" onclick="toggleCart()">Cart <span class="cart-badge" id="cartCount">0</span></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Shop Section -->
<div class="container mt-4">
  <h2 class="text-center mb-4 fw-bold">âœ¨ Our Latest Products</h2>
  <div class="row g-4" id="productContainer">
    <!-- Dynamic product cards will appear here -->
  </div>
</div>

<!-- NEW: Cart Drawer -->
<div id="cartDrawer">
  <h4>Your Cart</h4>
  <ul id="cartItems" class="list-group mb-3"></ul>
  <h5>Total: â‚¹<span id="cartTotal">0</span></h5>
  <button class="btn btn-success w-100 mb-2">Checkout</button>
  <button class="btn btn-secondary w-100" onclick="toggleCart()">Close</button>
</div>
<script>
const API = '/api/products';

// Reset cart for testing; remove this line in production
localStorage.removeItem('cart');

let cart = JSON.parse(localStorage.getItem('cart')) || [];
let productsData = [];

// Fetch and render products
async function fetchProducts() {
  try {
    const res = await fetch(API);
    if (!res.ok) throw new Error('Failed to fetch products');
    productsData = await res.json();

    const container = document.getElementById("productContainer");
    container.innerHTML = '';

    productsData.forEach(p => {
      const card = document.createElement('div');
      card.className = 'col-12 col-sm-6 col-md-4';
      card.innerHTML = `
        <div class="card product-card h-100 shadow-sm">
          <img src="${p.image}" alt="${escapeHtml(p.name)}" class="card-img-top">
          <div class="card-body d-flex flex-column">
            <h5 class="product-title">${escapeHtml(p.name)}</h5>
            <p class="product-category">${escapeHtml(p.category)}</p>
            <div class="mt-auto d-flex justify-content-between align-items-center">
              <span class="price">â‚¹${p.price}</span>
              <button class="btn btn-primary add-to-cart-btn px-3 py-1" onclick="addToCart('${p._id}')">
                <i class="bi bi-cart-plus"></i> Add
              </button>
            </div>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
    updateCartUI();
  } catch (err) {
    console.error(err);
  }
}

// Add to cart
function addToCart(id) {
  const product = productsData.find(p => p._id === id);
  if (!product) return;
  const existing = cart.find(item => item._id === id);
  if (existing) {
    existing.qty += 1;
  } else {
    cart.push({ ...product, qty: 1 });
  }
  saveCart();
  updateCartUI();
}

// Remove one quantity
function decreaseQty(id) {
  const item = cart.find(i => i._id === id);
  if (!item) return;
  item.qty -= 1;
  if (item.qty <= 0) {
    cart = cart.filter(i => i._id !== id);
  }
  saveCart();
  updateCartUI();
}

// Remove item completely
function removeFromCart(id) {
  cart = cart.filter(item => item._id !== id);
  saveCart();
  updateCartUI();
}

// Clear cart
function clearCart() {
  cart = [];
  saveCart();
  updateCartUI();
}

// Save to localStorage
function saveCart() {
  localStorage.setItem('cart', JSON.stringify(cart));
}

// Update cart UI
function updateCartUI() {
  document.getElementById('cartCount').innerText = cart.reduce((sum, item) => sum + item.qty, 0);
  const cartItemsEl = document.getElementById('cartItems');
  const cartTotalEl = document.getElementById('cartTotal');
  cartItemsEl.innerHTML = '';
  let total = 0;

  cart.forEach(item => {
    total += item.price * item.qty;
    cartItemsEl.innerHTML += `
      <li class="list-group-item d-flex align-items-center">
        <img src="${item.image}" alt="${escapeHtml(item.name)}" class="me-2 rounded" style="width:50px;height:50px;object-fit:cover;">
        <div class="flex-grow-1">
          <strong>${escapeHtml(item.name)}</strong>
          <div class="text-muted" style="font-size:0.85rem;">â‚¹${item.price} each</div>
          <div class="d-flex align-items-center mt-1">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="decreaseQty('${item._id}')">âˆ’</button>
            <span>${item.qty}</span>
            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="addToCart('${item._id}')">+</button>
          </div>
        </div>
        <div class="ms-2 text-end">
          â‚¹${item.price * item.qty}
          <button class="btn btn-sm btn-danger ms-1" onclick="removeFromCart('${item._id}')">Ã—</button>
        </div>
      </li>
    `;
  });

  cartTotalEl.innerText = total;
}

// Toggle cart drawer
function toggleCart() {
  document.getElementById('cartDrawer').classList.toggle('open');
}

// Escape HTML to prevent XSS
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"'`=\/]/g, s => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
    '/': '&#x2F;',
    '`': '&#x60;',
    '=': '&#x3D;'
  })[s]);
}

fetchProducts();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
