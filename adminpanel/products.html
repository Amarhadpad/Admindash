<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Products - ArtistGrade Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background:#f9f9f9; }
    .sidebar{ height:100vh; background:#343a40; padding-top:20px; }
    .sidebar a{ color:#adb5bd; text-decoration:none; display:block; padding:15px 20px; }
    .sidebar a:hover, .sidebar a.active { background:#495057; color:#fff; border-left:5px solid #6f42c1; }
    .dashboard-header{ padding:20px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    table th, table td { vertical-align: middle; }
    .product-img{ width:50px; height:50px; object-fit:cover; border-radius:5px; }
    .cursor-pointer{ cursor:pointer; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <nav class="col-md-2 d-none d-md-block sidebar">
      <div class="text-center text-white mb-4 fw-bold fs-4">AdminPanel</div>
      <a href="/dashboard"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
      <a href="/products" class="active"><i class="fas fa-box me-2"></i> Products</a>
      <a href="/orders"><i class="fas fa-shopping-cart me-2"></i> Orders</a>
      <a href="/users"><i class="fas fa-users me-2"></i> Users</a>
    </nav>

    <main class="col-md-10 ms-sm-auto px-md-4">
      <div class="dashboard-header mt-4 mb-4 d-flex justify-content-between align-items-center">
        <h3 class="fw-semibold">Products</h3>
        <div>
          <input id="searchInput" class="form-control d-inline-block w-25 me-2" placeholder="Search products...">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="fas fa-plus me-1"></i> Add New Product
          </button>
        </div>
      </div>

      <table class="table table-hover bg-white">
        <thead>
          <tr>
            <th>Image</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="productList"></tbody>
      </table>
    </main>
  </div>
</div>

<!-- Modal (used for both add and edit) -->
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="productForm" class="modal-content" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="id" id="productId">
        <div class="mb-3">
          <label class="form-label">Product Name</label>
          <input type="text" class="form-control" name="name" id="productName" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Category</label>
          <input type="text" class="form-control" name="category" id="productCategory" required>
        </div>
        <div class="mb-3 row">
          <div class="col">
            <label class="form-label">Price</label>
            <input type="number" class="form-control" name="price" id="productPrice" required>
          </div>
          <div class="col">
            <label class="form-label">Stock</label>
            <input type="number" class="form-control" name="stock" id="productStock" required>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Image (choose to replace or leave empty on edit)</label>
          <input type="file" class="form-control" name="image" id="productImage" accept="image/*">
          <img id="imagePreview" class="mt-2" style="max-width:150px; display:none;">
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" id="saveBtn" class="btn btn-success">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = '/api/products';

document.addEventListener('DOMContentLoaded', () => {
  fetchProducts();

  const form = document.getElementById('productForm');
  const preview = document.getElementById('imagePreview');
  const fileInput = document.getElementById('productImage');
  const modalEl = document.getElementById('addProductModal');
  const bootstrapModal = new bootstrap.Modal(modalEl);

  // image preview
  fileInput.addEventListener('change', (e) => {
    const f = e.target.files[0];
    if (f) {
      const reader = new FileReader();
      reader.onload = ev => {
        preview.src = ev.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(f);
    } else {
      preview.style.display = 'none';
      preview.src = '';
    }
  });

  // open modal for add: reset form
  modalEl.addEventListener('show.bs.modal', (e) => {
    const title = document.getElementById('modalTitle');
    if (!document.getElementById('productId').value) {
      title.textContent = 'Add Product';
      preview.style.display = 'none';
      form.reset();
    }
  });

  // submit form -> either create or update
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('productId').value;
    const formData = new FormData(form);

    try {
      const url = id ? `${API}/${id}` : API;
      const method = id ? 'PUT' : 'POST';
      const res = await fetch(url, { method, body: formData });
      if (!res.ok) throw new Error('Network response was not ok');
      await fetchProducts();
      bootstrapModal.hide();
      form.reset();
      document.getElementById('productId').value = '';
      preview.style.display = 'none';
    } catch (err) {
      alert('Error saving product');
      console.error(err);
    }
  });

  // Search
  document.getElementById('searchInput').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('#productList tr').forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
    });
  });
});

// load and render
async function fetchProducts() {
  const res = await fetch(API);
  const products = await res.json();
  const list = document.getElementById('productList');
  list.innerHTML = '';
  products.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${p.image}" class="product-img"></td>
      <td>${escapeHtml(p.name)}</td>
      <td>${escapeHtml(p.category)}</td>
      <td>â‚¹${p.price}</td>
      <td>${p.stock}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="startEdit('${p._id}')"><i class="fas fa-edit"></i></button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p._id}')"><i class="fas fa-trash"></i></button>
      </td>
    `;
    list.appendChild(tr);
  });
}

// begin editing a product
async function startEdit(id) {
  try {
    const res = await fetch(`${API}/${id}`);
    if (!res.ok) throw new Error('Not found');
    const p = await res.json();
    document.getElementById('productId').value = p._id;
    document.getElementById('productName').value = p.name;
    document.getElementById('productCategory').value = p.category;
    document.getElementById('productPrice').value = p.price;
    document.getElementById('productStock').value = p.stock;

    const preview = document.getElementById('imagePreview');
    preview.src = p.image;
    preview.style.display = 'block';

    // show modal
    new bootstrap.Modal(document.getElementById('addProductModal')).show();
  } catch (err) {
    alert('Unable to fetch product');
    console.error(err);
  }
}

// delete
async function deleteProduct(id) {
  if (!confirm('Delete this product?')) return;
  try {
    const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('Delete failed');
    await fetchProducts();
  } catch (err) {
    alert('Error deleting product');
    console.error(err);
  }
}

// small helper to escape text in table
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"'`=\/]/g, function (s) {
    return ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;',
      "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
    })[s];
  });
}
</script>
</body>
</html>
